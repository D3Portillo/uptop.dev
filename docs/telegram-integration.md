# Telegram Integration

This integration allows fetching job postings from Telegram channels to enrich our job listings with real-time data, including accurate publication dates and client information.

## Overview

The Telegram integration uses the official MTProto API via the `telegram` npm package to read messages from public channels. Once authenticated, the session persists indefinitely without requiring manual intervention.

## Architecture

- **scripts/telegram-auth.ts** - One-time authentication script that generates a session string
- **lib/telegram-client.ts** - Client wrapper with connection pooling and message fetching
- **app/api/telegram-jobs/route.ts** - API endpoint that fetches and parses Telegram messages into job objects

## Required Environment Variables

Add these to your `.env.local`:

```bash
# Get from https://my.telegram.org
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash

# Generated by running the auth script (see below)
TELEGRAM_SESSION=your_session_string
```

## Setup Steps

### 1. Get API Credentials

- Go to https://my.telegram.org
- Login with your phone number
- Navigate to "API development tools"
- Create a new application
- Copy the `api_id` and `api_hash`

### 2. Run One-Time Authentication

```bash
npx tsx scripts/telegram-auth.ts
```

The script will prompt you for:

- **Phone number** (international format: +1234567890)
- **Telegram code** (sent to your Telegram app)
- **2FA password** (if enabled on your account)

After successful authentication, copy the session string to your `.env.local` as `TELEGRAM_SESSION`.

### 3. Test the Integration

Start your dev server and test the endpoint:

```bash
pnpm dev
curl http://localhost:3000/api/telegram-jobs
```

## API Usage

### GET /api/telegram-jobs

Fetches the latest 100 messages from the configured Telegram channel and parses them into job objects.

**Response:**

```json
[
  {
    "clientName": "Acme Corp",
    "datePosted": "2026-01-13T10:00:00.000Z",
    "formattedJobID": "abc123def456",
    "companySite": "https://acme.com",
    "faviconBaseDomain": "acme.com"
  }
]
```

## Message Parsing Logic

**Note:** The current parser is tailored specifically for this channel's format and is optional. Customize it based on your channel's message structure.

The parser:

1. Filters messages containing `"CLIENT â€” "` marker
2. Extracts client name from the line after the marker
3. Parses Notion link for the job ID (last segment after `-`)
4. Extracts company website (non-Notion links)
5. Derives favicon domain from company site

This parsing is **channel-specific**. For different channels, modify the parsing logic in [app/api/telegram-jobs/route.ts](../app/api/telegram-jobs/route.ts) to match their format.

## Integration with Existing Jobs

To merge Telegram data with your existing job listings:

```typescript
// Fetch Telegram metadata in parallel with your jobs
const [jobs, telegramMeta] = await Promise.all([
  getJobsFromDatabase(),
  fetch("/api/telegram-jobs").then((r) => r.json()),
])

// Enrich jobs with Telegram metadata (client, datePosted, etc.)
const enrichedJobs = jobs.map((job) => {
  const meta = telegramMeta.find((t) => t.formattedJobID === job.id)
  return meta ? { ...job, ...meta } : job
})
```

## Channel Configuration

The channel ID is hardcoded in `app/api/telegram-jobs/route.ts`:

```typescript
// Replace with your desired channel ID
const CHANNEL_ID = -1
```

To fetch from multiple channels, modify the endpoint to accept a channel ID parameter or create separate endpoints.

## Session Management

The session string is a base64-encoded authentication token that:

- Persists indefinitely unless revoked
- Does not expire automatically
- Can be revoked from Telegram Settings > Privacy > Active Sessions

If you need to regenerate the session, re-run the auth script.

## Troubleshooting

**"Missing TELEGRAM_API_ID or TELEGRAM_API_HASH"**

- Ensure env vars are set in `.env.local`
- Restart your dev server after adding env vars

**"Could not find the input entity"**

- Channel ID may be incorrect
- Ensure you're subscribed to the channel

**"AUTH_KEY_UNREGISTERED"**

- Session string is invalid or expired
- Re-run the auth script to generate a new session

## Security Notes

- Keep your session string private (never commit to git)
- The session has the same permissions as your Telegram account
- Consider using a dedicated Telegram account for production deployments
- Add `.env.local` to `.gitignore` (should already be there)

## Future Enhancements

- Add cron job to periodically fetch new messages
- Store parsed jobs in database to avoid refetching
- Implement webhook support for real-time updates
- Add support for multiple channels
- Improve parsing with LLM-based extraction for better accuracy
